{% load static %}
{% load is_status %}
{% load django_bootstrap5 %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'img/fav/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=3.0">
</head>
<body>
  
<header class="header">
    <div class="container">
        <nav class="nav">
            <a href="{% url 'about' %}" class="logo-link">
                <img src="{% static 'img/fav/favicon_cor.png' %}" class="logo">
            </a>
            
            <div class="info-buttons">
                <a href="{% url 'about' %}">Информация о проекте</a>
                <a href="{% url 'news:news_page' %}">Новости</a>
            </div>
            
            <div class="info-buttons">
                {% if user.is_authenticated %}
                    <a href="{% url 'personal_account:user_profile' username=user.username %}">Профиль</a>
                    <form method="post" action="{% url 'personal_account:logout' %}" class="auth-form">
                        {% csrf_token %}
                        <button type="submit" class="auth-btn">Выйти</button>
                    </form>
                {% else %}
                    <a href="{% url 'personal_account:login' %}" class="auth-btn">Войти</a>
                    <a href="{% url 'personal_account:signup' %}" class="auth-btn">Регистрация</a>
                {% endif %}
            </div>
        </nav>
    </div>
</header>
    
    <main class="main">
        <div class="container">
        {% include 'messages.html' %}
            <div class="profile-container">
                <div class="sidebar">
                    <div class="menu-section">
                        <h3>Меню</h3>
                        <button data-url="{% url 'personal_account:user_profile' username=user.username %}" class="menu-item active">Профиль</button>
                        {% with status=user|is_status_template %}
                            {% if status == "Кандидат" or status == "Член потребительского кооператива" or status == "Пайщик" or status == "Консультант" %}
                                {% if status == "Член потребительского кооператива" or status == "Пайщик" or status == "Консультант" %}
                                    <button id="payment-schedule-btn" class="menu-item">Мои платежи</button>
                                    <div id="payment-schedule-submenu" class="submenu">
                                        <button class="submenu-item">График платежей</button>
                                        <button class="submenu-item">Исторя платежей</button>
                                        <button class="submenu-item">Сделать платёж</button>
                                        <button class="submenu-item" data-url="{% url 'personal_account:requisites' %}">Реквизиты</button>
                                    </div>
                                    <button class="menu-item" data-url="{% url 'personal_account:referral' %}">Партнёрство</button>
                                    <button class="menu-item">Очередь</button>
                                    <button class="menu-item">Долги</button>
                                {% endif %}
                                <button id="supply-schedule-btn" class="menu-item">Подать заявление</button>
                                <div id="supply-schedule-submenu" class="submenu">
                                    <button class="submenu-item">Стать пайщиком</button>
                                    {% if status == "False"%}
                                        <button class="submenu-item" data-url="{% url 'personal_account:referral' %}">Стать консультантом</button>
                                    {% endif %}
                                    <button class="submenu-item">На участие в целевой программе</button>
                                </div>
                            {% endif %}
                        {% endwith %}
                        <button data-url="{% url 'donation' %}" class="menu-item">Добровольное пожертвование</button>
                        <button class="menu-item">Уведомления</button>
                        <button data-url="{% url 'personal_account:help' %}" class="menu-item">Помощь</button>
                    </div>
                </div>
                
                {% block content %}
                {% endblock content %}
            </div>
        </div>
    </main>
    
    <footer class="footer">
        <div class="container">
            <p>&copy; {% now "Y" %} Bestwaycoop. All rights reserved.</p>
            <a href="http://t.me/bw_bestwaycoop" style="text-decoration: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 5px;">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.03-.1.06-.2-.06-.3s-.35-.04-.5-.03c-.21.03-3.57 2.26-5.04 3.18-.48.3-.92.45-1.32.44-.43-.01-1.27-.24-1.89-.44-.75-.25-1.35-.38-1.3-.8.03-.27.4-.55 1.1-.85 4.43-1.94 7.37-3.22 11.2-4.96.53-.2 1.01-.3 1.45-.3.31.01.9.17.9.66.01.33-.33.76-.5 1.02z"/>
                </svg>
                <span>Наш Telegram</span>
            </a>
        </div>
    </footer>
    
</body>

<style>
    html, body {
        -webkit-text-size-adjust: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        background: #f1f3f5;
        color: #212529;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.4;
    }
    *, *::before, *::after { box-sizing: inherit; }

    .profile-container {
        display: flex;
        width: 100%;
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        padding: 0 12px;
    }

    .sidebar, .content { min-width: 0; }

    .sidebar {
        width: 33.333%;
        background: #f8f9fa;
        padding: 25px;
        border-right: 1px solid #e9ecef;
    }

    .menu-section { margin-bottom: 30px; }

    .menu-section h3 {
        font-size: 18px;
        color: #212529;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .menu-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #495057;
        text-decoration: none;
        background: white;
        border: 1px solid #e9ecef;
        width: 100%;
        text-align: left;
        font-family: inherit;
        font-size: inherit;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .menu-item:hover { background: #e9ecef; border-color: #ced4da; }

    .menu-item.active { background: #007bff; color: white; border-color: #007bff; font-weight: 500; }

    .content { width: 66.667%; padding: 30px; }

    .profile-header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 5px solid #e9ecef; }
    .profile-header h2 { font-size: 24px; color: #212529; margin: 0; }

    .info-section { margin-bottom: 25px; }

    .info-row, .info-row_next {
        display: flex;
        gap: 12px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f1f3f5;
        align-items: flex-start;
    }

    .info-row_next { border-bottom: 5px solid #e9ecef; }

    .info-label { width: 40%; color: #6c757d; font-weight: 500; min-width: 0; }
    .info-value { width: 60%; color: #212529; font-weight: 400; min-width: 0; }

    .profile-actions { margin-top: 25px; padding-top: 15px; border-top: 1px solid #e9ecef; }

    .edit-button { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; font-weight: 500; transition: background 0.2s ease; }
    .edit-button:hover { background: #0069d9; text-decoration: none; color: white; }
    .submenu {
        display: none;
        margin-left: 15px;
        margin-top: 5px;
        background: #ffffff;
        border-left: 3px solid #007bff;
        border-radius: 6px;
        padding: 8px 10px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        max-width: calc(100% - 30px);
        box-sizing: border-box;
    }

    .submenu-item {
        display: block;
        width: 100%;
        background: #f8f9fa;
        border: none;
        padding: 8px 10px;
        margin-bottom: 5px;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        font-size: 14px;
        color: #495057;
        transition: all 0.2s ease;
    }

    .submenu-item:hover { background: #e9ecef; }

    img, svg, iframe, video, table { max-width: 100%; height: auto; display: ; }

    @media (max-width: 992px) {
        .profile-container { flex-direction: column; padding: 0 10px; }
        .sidebar, .content { width: 100%; }
        .sidebar { border-right: none; border-bottom: 1px solid #e9ecef; }
    }

    @media (max-width: 576px) {
        .profile-container { margin: 12px 8px; border-radius: 8px; }
        .sidebar { padding: 16px; }
        .content { padding: 0px; }
        .info-row, .info-row_next { flex-direction: column; padding-bottom: 12px; }
        .info-label, .info-value { width: 100%; }
        .menu-item { padding: 10px 12px; font-size: 14px; white-space: normal; }
        .messages-container { top: auto; bottom: 16px; left: 50%; transform: translateX(-50%); width: calc(100% - 24px); max-width: calc(100% - 24px); }
        .submenu { margin-left: 0; padding-left: 10px; }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const menuItems = document.querySelectorAll('.menu-item');
        const currentUrl = window.location.href;
        
        menuItems.forEach(item => {
            const itemUrl = item.getAttribute('data-url');
            if (currentUrl.includes(itemUrl) && itemUrl !== '#') {
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            }
        });
        
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                menuItems.forEach(i => i.classList.remove('active'));
                
                this.classList.add('active');
                
                const url = this.getAttribute('data-url');
                if (url && url !== '#') {
                    window.location.href = url;
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Функция для безопасной инициализации меню
        function initMenu(buttonId, submenuId, otherSubmenuIds = []) {
            const button = document.getElementById(buttonId);
            const submenu = document.getElementById(submenuId);
            
            if (button && submenu) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Закрываем другие submenu
                    otherSubmenuIds.forEach(otherId => {
                        const otherSubmenu = document.getElementById(otherId);
                        if (otherSubmenu) otherSubmenu.style.display = 'none';
                    });
                    
                    // Переключаем текущий
                    const isVisible = submenu.style.display === 'block';
                    submenu.style.display = isVisible ? 'none' : 'block';
                });
                
                return true;
            }
            return false;
        }

        // Инициализируем меню платежей (если есть)
        const paymentMenuExists = initMenu(
            'payment-schedule-btn', 
            'payment-schedule-submenu',
            ['supply-schedule-submenu'] // Закрывать меню поставок при открытии
        );

        // Инициализируем меню поставок (если есть)
        const supplyMenuExists = initMenu(
            'supply-schedule-btn', 
            'supply-schedule-submenu',
            ['payment-schedule-submenu'] // Закрывать меню платежей при открытии
        );

        // Обработка кликов по пунктам подменю
        const submenuItems = document.querySelectorAll('.submenu-item');
        submenuItems.forEach(item => {
            item.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                if (url) {
                    window.location.href = url;
                }
            });
        });

        // Закрытие всех submenu при клике вне области
        document.addEventListener('click', function(e) {
            // Проверяем, был ли клик вне кнопок и подменю
            const isPaymentClick = document.getElementById('payment-schedule-btn')?.contains(e.target) || 
                                document.getElementById('payment-schedule-submenu')?.contains(e.target);
            
            const isSupplyClick = document.getElementById('supply-schedule-btn')?.contains(e.target) || 
                                document.getElementById('supply-schedule-submenu')?.contains(e.target);
            
            if (!isPaymentClick && !isSupplyClick) {
                // Закрываем все подменю
                const paymentSubmenu = document.getElementById('payment-schedule-submenu');
                const supplySubmenu = document.getElementById('supply-schedule-submenu');
                
                if (paymentSubmenu) paymentSubmenu.style.display = 'none';
                if (supplySubmenu) supplySubmenu.style.display = 'none';
            }
        });

        // Предотвращаем закрытие при клике внутри подменю
        const submenus = document.querySelectorAll('.submenu');
        submenus.forEach(submenu => {
            if (submenu) {
                submenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });
    });

    function formatNumberWithSpaces(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    function formatPriceField(selector) {
        const element = document.querySelector(selector);
        if (!element) return;
        
        let text = element.textContent.trim();
        const match = text.match(/([\d.,]+)\s*руб/);
        
        if (match) {
            let numberStr = match[1];
            numberStr = numberStr.replace('.', ',');
            
            const parts = numberStr.split(',');
            let integerPart = parts[0].replace(/\s/g, '');
            let decimalPart = parts[1] ? '.' + parts[1] : '';
            
            integerPart = formatNumberWithSpaces(integerPart);
            const formattedNumber = integerPart + decimalPart;
            
            element.textContent = text.replace(match[0], formattedNumber + ' руб');
        }
    }

    function formatAllPrices() {
        formatPriceField('#priceMain');
        formatPriceField('#priceQueue');
    }

    document.addEventListener('DOMContentLoaded', formatAllPrices);
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('copyButton').addEventListener('click', function() {
            const copyText = document.getElementById("referralLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(copyText.value).then(() => {
                const button = this;
                const originalText = button.textContent;
                button.textContent = 'Скопировано!';
                button.style.background = '#d4edda';
                button.style.borderColor = '#c3e6cb';
                button.style.color = '#155724';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.style.borderColor = '';
                    button.style.color = '';
                }, 2000);
            });
        });

        document.querySelectorAll('.partner-item').forEach(item => {
            item.addEventListener('click', function() {
                const name = this.getAttribute('data-name');
                const email = this.getAttribute('data-email');
                const phone = this.getAttribute('data-phone');
                const date = this.getAttribute('data-date');
                
                showPartnerDetails(name, email, phone, date);
            });
        });

        const modal = document.getElementById('partnerModal');
        const closeBtn = document.querySelector('.close');
        
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
    });

    function showPartnerDetails(name, email, phone, date) {
        document.getElementById('modal-name').textContent = name;
        document.getElementById('modal-email').textContent = email;
        document.getElementById('modal-phone').textContent = phone;
        document.getElementById('modal-date').textContent = date;
        
        const modal = document.getElementById('partnerModal');
        modal.style.display = 'block';
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Функции для модального окна
        const modal = document.getElementById('partnerModal');
        const closeBtn = document.querySelector('.close');
        const partnerItems = document.querySelectorAll('.partner-item');
        
        partnerItems.forEach(item => {
            item.addEventListener('click', function() {
                document.getElementById('modal-name').textContent = this.dataset.name;
                document.getElementById('modal-email').textContent = this.dataset.email;
                document.getElementById('modal-phone').textContent = this.dataset.phone;
                document.getElementById('modal-date').textContent = this.dataset.date;
                modal.style.display = 'block';
            });
        });
        
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Копирование ссылки
        document.getElementById('copyButton').addEventListener('click', function() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            this.textContent = 'Скопировано!';
            setTimeout(() => {
                this.textContent = 'Копировать';
            }, 2000);
        });
        
        // Функции для фильтров
        const statusFilter = document.getElementById('statusFilter');
        const dateFilter = document.getElementById('dateFilter');
        const resetButton = document.getElementById('resetFilters');
        
        // Выбираем только партнеров из списка "Ваши партнёры", исключая консультанта
        const partnerItemsList = document.querySelectorAll('#referralsList .referral-item');
        
        function applyFilters() {
            const selectedStatus = statusFilter.value;
            const selectedDate = dateFilter.value;
            const now = new Date();
            
            partnerItemsList.forEach(item => {
                let showItem = true;
                const itemStatus = item.dataset.status;
                const itemTimestamp = parseInt(item.dataset.timestamp) * 1000;
                const itemDate = new Date(itemTimestamp);
                
                // Фильтр по статусу
                if (selectedStatus !== 'all' && itemStatus !== selectedStatus) {
                    showItem = false;
                }
                
                // Фильтр по дате
                if (showItem && selectedDate !== 'all') {
                    const startOfDay = new Date(now);
                    startOfDay.setHours(0, 0, 0, 0);
                    
                    switch(selectedDate) {
                        case 'today':
                            if (itemDate < startOfDay) {
                                showItem = false;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(now.getDate() - 7);
                            if (itemDate < weekAgo) {
                                showItem = false;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(now.getMonth() - 1);
                            if (itemDate < monthAgo) {
                                showItem = false;
                            }
                            break;
                        case 'year':
                            const yearAgo = new Date(now);
                            yearAgo.setFullYear(now.getFullYear() - 1);
                            if (itemDate < yearAgo) {
                                showItem = false;
                            }
                            break;
                    }
                }
                
                // Показываем/скрываем элемент
                if (showItem) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        // События для фильтров
        statusFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        
        resetButton.addEventListener('click', function() {
            statusFilter.value = 'all';
            dateFilter.value = 'all';
            applyFilters();
        });
        
        // Инициализация фильтров при загрузке
        applyFilters();
    });
</script>
